name: Release ClaudeMeter

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version from changelog
        id: version
        run: |
          VERSION=$(sed -n 's/^## \[\([^]]*\)\].*/\1/p' CHANGELOG.md | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract changelog
        id: changelog
        run: |
          VERSION=$(sed -n 's/^## \[\([^]]*\)\].*/\1/p' CHANGELOG.md | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          CONTENT=$(awk '
            /^## \[/ {
              if (found) exit
              found=1
              next
            }
            found { print }
          ' CHANGELOG.md)

          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Update version in project
        run: |
          sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = ${{ steps.version.outputs.version }}/g" ClaudeMeter.xcodeproj/project.pbxproj

          BUILD_NUMBER=$(echo "${{ steps.version.outputs.version }}" | sed 's/[^0-9]*\([0-9]*\).*/\1/')
          sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = $BUILD_NUMBER/g" ClaudeMeter.xcodeproj/project.pbxproj

          echo "Updated version to ${{ steps.version.outputs.version }} (build $BUILD_NUMBER)"

      - name: Build app
        run: |
          xcodebuild clean build \
            -project ClaudeMeter.xcodeproj \
            -scheme ClaudeMeter \
            -configuration Release \
            -derivedDataPath ./build \
            -arch x86_64 -arch arm64 \
            CODE_SIGNING_ALLOWED=NO

      - name: Create ZIP
        run: |
          cd build/Build/Products/Release
          xattr -cr ClaudeMeter.app
          find ClaudeMeter.app -name '._*' -delete
          zip -r ../../../../ClaudeMeter-${{ steps.version.outputs.version }}.zip ClaudeMeter.app

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ClaudeMeter v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          files: ClaudeMeter-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
